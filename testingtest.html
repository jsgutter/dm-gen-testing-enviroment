<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DM Name Generator</title>
  <meta name="description" content="Build consistent asset names from a documented naming convention." />

  <!-- Inter font like the screenshot -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Light theme ‚Äî default */
      --bg:#f5f7fb;
      --fg:#111827;
      --muted:#6b7280;
      --card:#ffffff;
      --card-2:#f3f6fb;
      --border:#e7ebf2;
      --brand:#2563eb;
      --brand-2:#1d4ed8;
      --focus: 2px solid color-mix(in srgb, var(--brand), white 65%);
      --pill:#eef2f8;
      --success:#10b981;
      --danger:#ef4444;
      --shadow: 0 1px 2px rgba(16,24,40,.04), 0 8px 24px rgba(16,24,40,.06);
      --radius:16px;
    }
    html[data-theme="dark"]{
      --bg:#0c1116; --fg:#e6edf3; --muted:#9aa3ad; --card:#0f141b; --card-2:#0b1016; --border:#1f2a37;
      --brand:#6ea8fe; --brand-2:#2b6ee7; --focus:2px solid color-mix(in srgb, var(--brand), transparent 40%); --pill:#141823;
      --success:#22c55e; --danger:#f87171; --shadow:0 0 0 1px rgba(0,0,0,.5), 0 10px 28px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:14px/1.55 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--brand); text-decoration:none}
    .container{max-width:1180px;margin-inline:auto;padding:28px 24px}

    /* Page header */
    header.page{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    h1{margin:0;font-size:28px;font-weight:700;letter-spacing:.2px}
    .topmeta p{margin:6px 0 0;color:var(--muted)}
    .themeToggle{
      border:1px solid var(--border); background:var(--card); color:var(--fg);
      border-radius:12px; padding:10px 12px; cursor:pointer; box-shadow:var(--shadow)
    }

    /* Layout */
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:18px}
    .panel{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden
    }
    .panel header{
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border); padding:14px 16px
    }
    .panel header h2{font-size:16px;margin:0;font-weight:600}

    .panel main{padding:16px}

    /* Left form */
    .row{display:grid; grid-template-columns: 220px 1fr; gap:12px; align-items:center; margin-bottom:12px}
    .label{display:flex; flex-direction:column; gap:6px}
    .label small{color:var(--muted)}
    .select{display:flex; gap:8px; align-items:center; width:100%}
    select, input[type="url"]{
      appearance:none; width:100%;
      background:var(--card-2); color:var(--fg);
      border:1px solid var(--border); border-radius:12px; padding:10px 12px;
      transition:border-color .15s ease, box-shadow .15s ease
    }
    select:focus,input[type="url"]:focus{outline:var(--focus)}
    select.missing{border-color:var(--danger)!important; box-shadow:0 0 0 2px color-mix(in srgb, var(--danger), transparent 70%)}

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border); border-radius:999px; background:var(--pill);
      padding:4px 10px; font-size:12px; color:var(--muted)
    }
    .btn{
      border:1px solid var(--border); background:var(--pill); color:var(--fg);
      border-radius:999px; padding:8px 14px; cursor:pointer
    }
    .btn.primary{
      background:var(--brand); border-color:transparent; color:#fff; font-weight:600
    }
    .btn.clear{background:transparent}
    .btn[disabled]{opacity:.55; cursor:not-allowed}

    /* Output block + status */
    .out{display:flex; flex-direction:column; gap:10px; margin-top:10px}
    .out pre{
      background:#0a0f1a; color:#e6edf3;
      border:1px dashed color-mix(in srgb, #ffffff, transparent 85%);
      border-radius:14px; padding:14px; min-height:68px; display:flex; align-items:center;
      font-family:ui-monospace, Menlo, Consolas, monospace; font-size:13px; letter-spacing:.25px
    }
    .copybar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--pill)
    }
    .pill b{font-size:12px}
    .pill.ok{border-color:color-mix(in srgb, var(--success), transparent 70%); color:var(--success); background:color-mix(in srgb, var(--success), transparent 88%)}
    .pill.warn{border-color:color-mix(in srgb, var(--danger), transparent 70%); color:#ef9a9a; background:color-mix(in srgb, var(--danger), transparent 90%)}

    /* Recents */
    .recent{margin-top:14px}
    .recent h3{margin:8px 0 8px; font-size:13px; color:var(--muted)}
    .recent-list{display:flex; flex-wrap:wrap; gap:8px}
    .recent-pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px;
      border:1px solid var(--border); border-radius:999px; background:var(--pill)
    }
    .recent-pill code{
      background:var(--card-2); border:1px solid var(--border); border-radius:8px; padding:2px 6px;
      font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px
    }
    .recent-pill button{border:none; background:transparent; cursor:pointer; color:var(--muted)}

    /* Right panel (accordion-like details per group) */
    details{border:1px solid var(--border); border-radius:12px; background:var(--card-2)}
    details+details{margin-top:10px}
    details > summary{cursor:pointer; list-style:none; padding:10px 12px; font-weight:500}
    details[open] > summary{border-bottom:1px solid var(--border); background:color-mix(in srgb, var(--card), var(--pill) 50%)}
    .kvs{display:flex; flex-direction:column; gap:8px; padding:10px 12px}
    .kv{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
    .kv code{
      background:var(--card); border:1px solid var(--border); border-radius:8px; padding:4px 6px;
      font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px
    }

    /* Misc */
    .toast{position:fixed; inset:auto 16px 16px auto; background:var(--card); border:1px solid var(--border);
      border-radius:12px; padding:8px 10px; color:var(--fg); box-shadow:var(--shadow)}
    .skip{position:absolute; inset:auto auto auto -9999px}
    .skip:focus{inset:10px auto auto 10px; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:6px 10px}
    pre{white-space:pre-wrap; word-break:break-word}
    .footer small{color:var(--muted)}
    .copyright{color:var(--muted); font-size:12px; margin-left:2px}

    /* Responsive tweaks */
    @media (max-width: 1100px){
      .grid{grid-template-columns:1fr; gap:14px}
    }
    @media (max-width: 720px){
      header.page{flex-direction:column; align-items:flex-start; gap:10px}
      .row{grid-template-columns:1fr; gap:8px}
      .panel main{padding:14px}
      .panel header{padding:12px 14px}
      .container{padding:22px 16px}
    }
    @media (prefers-reduced-motion:no-preference){
      .panel, .themeToggle, select, input[type="url"], .btn{transition:box-shadow .2s ease, transform .05s ease}
      .btn:active{transform:translateY(1px)}
      select:hover, .themeToggle:hover{box-shadow:0 2px 8px rgba(0,0,0,.08)}
    }


/* Increased vertical space between sections inside panels */
.panel main h2, 
.panel main h3, 
.panel main header {
  margin-top: 22px !important; /* ‚Üê increase/decrease this for more/less space */
}

.panel main .row {
  margin-top: 6px;   /* space above each row */
  margin-bottom: 14px; /* space below each row */
}


/* Add more vertical space between generator sections */
.pair {
  margin-bottom: 32px;
}
#pairs {
  margin-top: -22px; /* adjust this number as needed */
}

  </style>
</head>
<body>
  <a class="skip" href="#main">Skip to main content</a>

  <header class="page container">
    <div class="topmeta">
      <h1>[DM Ops] Name Generator</h1>
      <p>Build consistent names for Campaigns, Ad Groups, and Assets based on the standardized Naming Convention. To add or edit parameters/values contact DM Ops.</p>
    </div>
    <button id="themeBtn" class="themeToggle" type="button" aria-label="Toggle theme">üåì</button>
  </header>

  <main id="main" class="container">
    <div id="pairs"></div>
  </main>

  <footer class="container" style="margin-top:16px">
    <div class="footer">
      <small class="copyright">¬© 2025 DM Marketing Ops</small>
    </div>
  </footer>

  <script>
  const THEME_KEY='ng_theme_v1';
  const SCHEMA_KEY='ng_schema_v1';

  // CSV URL as primary source - try multiple formats
  const CSV_URLS = [
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy4oNj0EnjMou8kN_0jSDa1XQV25ONhV1Khul3oARi1FzWAhyFX6UBrXNvgtutRWhfbLzTOjDeRUV9/pub?output=csv',
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRy4oNj0EnjMou8kN_0jSDa1XQV25ONhV1Khul3oARi1FzWAhyFX6UBrXNvgtutRWhfbLzTOjDeRUV9/pub?output=csv&gid=0'
  ];

  const themeBtn=document.getElementById('themeBtn');
  function loadTheme(){
    try{ const t=localStorage.getItem(THEME_KEY); if(t){document.documentElement.setAttribute('data-theme', t);} }catch(e){}
  }
  function setTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    try{localStorage.setItem(THEME_KEY, t);}catch(e){}
  }
  themeBtn.addEventListener('click',()=>{
    const cur=document.documentElement.getAttribute('data-theme')||'light';
    setTheme(cur==='dark'?'light':'dark');
  });
  loadTheme();

  let MASTER = null; // No embedded fallback
  let SCHEMA_MODE = 'Loading...';

  function toast(msg){
    const t=document.createElement('div');
    t.className='toast'; t.setAttribute('role','status'); t.setAttribute('aria-live','polite');
    t.textContent=msg; document.body.appendChild(t);
    setTimeout(()=>t.remove(), 1200);
  }

  function byCase(str, c){
    if(c==='lower') return (str||'').toLowerCase();
    if(c==='upper') return (str||'').toUpperCase();
    return str||'';
  }

  // Better CSV parser that handles quoted fields
  function parseCSVRow(row) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < row.length; i++) {
      const char = row[i];
      
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    
    result.push(current.trim());
    return result;
  }

  // Parse CSV data and convert to JSON schema format
  function parseCSVToSchema(csvText) {
    console.log('Parsing CSV with length:', csvText.length);
    
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) throw new Error('CSV must have headers and at least one data row');

    const headers = parseCSVRow(lines[0]);
    console.log('CSV headers:', headers);
    
    const generators = {};

    // Process each row
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue; // Skip empty lines
      
      const values = parseCSVRow(lines[i]);
      if (values.length < headers.length) {
        console.warn(`Row ${i + 1} has fewer columns than headers, skipping`);
        continue;
      }

      const row = {};
      headers.forEach((header, idx) => {
        row[header] = (values[idx] || '').replace(/^"|"$/g, ''); // Remove surrounding quotes
      });

      // Try different possible column name variations
      const generatorId = row.generator_id || row.Generator || row.generator || row.ID || 'default';
      const generatorTitle = row.generator_title || row.Title || row.title || row.Generator || 'Generator';
      const fieldName = row.field_name || row.Field || row.field || row.Parameter || '';
      const label = row.label || row.Label || row.Name || '';
      const code = row.code || row.Code || row.Value || '';
      const optional = (row.optional || row.Optional || '').toLowerCase() === 'true' || row.optional === '1';
      const delimiter = row.delimiter || row.Delimiter || '_';
      const caseType = row.case || row.Case || 'lower';

      // Skip rows without essential data
      if (!generatorId || !fieldName || !label || !code) {
        console.warn(`Row ${i + 1} missing essential data:`, { generatorId, fieldName, label, code });
        continue;
      }

      if (!generators[generatorId]) {
        generators[generatorId] = {
          id: generatorId,
          title: generatorTitle,
          order: [],
          delimiter: delimiter,
          case: caseType,
          optional: [],
          fields: {}
        };
      }

      const gen = generators[generatorId];

      // Add field to order if not already present
      if (fieldName && !gen.order.includes(fieldName)) {
        gen.order.push(fieldName);
      }

      // Add to optional if marked as optional
      if (optional && !gen.optional.includes(fieldName)) {
        gen.optional.push(fieldName);
      }

      // Add field values
      if (!gen.fields[fieldName]) {
        gen.fields[fieldName] = [];
      }
      gen.fields[fieldName].push({ label, code });
    }

    console.log('Parsed generators:', Object.keys(generators));

    if (Object.keys(generators).length === 0) {
      throw new Error('No valid generators found in CSV data');
    }

    return {
      generators: Object.values(generators)
    };
  }

  // Load schema from CSV (primary source) - try multiple URLs
  async function loadFromCSV() {
    for (let i = 0; i < CSV_URLS.length; i++) {
      const url = CSV_URLS[i];
      try {
        console.log(`Attempting to load CSV from (${i + 1}/${CSV_URLS.length}):`, url);
        
        const response = await fetch(url, { 
          cache: 'no-store',
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const csvText = await response.text();
        console.log('CSV loaded, first 200 chars:', csvText.substring(0, 200));
        
        if (!csvText || csvText.trim().length === 0) {
          throw new Error('CSV file is empty');
        }
        
        const schema = parseCSVToSchema(csvText);
        
        if (!schema || !Array.isArray(schema.generators) || schema.generators.length === 0) {
          throw new Error('No valid generators found in CSV');
        }

        console.log('CSV parsed successfully, generators found:', schema.generators.length);
        
        MASTER = schema;
        SCHEMA_MODE = 'CSV Data';
        
        // Cache the successful result
        try { 
          localStorage.setItem(SCHEMA_KEY, JSON.stringify(MASTER)); 
        } catch(e) {
          console.warn('Failed to cache CSV data:', e);
        }
        
        renderAll();
        return true;
      } catch (error) {
        console.error(`CSV load failed for URL ${i + 1}:`, error);
        if (i === CSV_URLS.length - 1) {
          // Only show toast on final failure
          toast(`All CSV sources failed. Last error: ${error.message}`);
        }
      }
    }
    return false;
  }

  // Load schema from remote JSON (fallback)
  async function loadFromRemoteJSON(url) {
    try {
      const response = await fetch(url, { cache: 'no-store' });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const json = await response.json();
      if (!json || !Array.isArray(json.generators)) {
        throw new Error('Invalid JSON schema format');
      }

      MASTER = json;
      SCHEMA_MODE = 'Remote JSON';
      
      // Cache the successful result
      try { 
        localStorage.setItem(SCHEMA_KEY, JSON.stringify(MASTER)); 
      } catch(e) {}
      
      renderAll();
      return true;
    } catch (error) {
      console.warn(`Remote JSON load failed from ${url}:`, error.message);
      return false;
    }
  }

  // Try to load from localStorage cache
  function loadFromCache() {
    try {
      const cached = localStorage.getItem(SCHEMA_KEY);
      if (cached) {
        const schema = JSON.parse(cached);
        if (schema && Array.isArray(schema.generators)) {
          MASTER = schema;
          SCHEMA_MODE = 'Cached Data';
          renderAll();
          return true;
        }
      }
    } catch (error) {
      console.warn('Cache load failed:', error.message);
    }
    return false;
  }

  function renderConvention(panelRight, gen){
    panelRight.innerHTML = '';
    const main = document.createElement('main');

    const groups = Object.entries(gen.fields || {});

    groups.forEach(([group, arr])=>{
      const d = document.createElement('details');
      const s = document.createElement('summary'); s.textContent = group; d.appendChild(s);
      const wrap = document.createElement('div'); wrap.className = 'kvs'; d.appendChild(wrap);

      (arr || []).forEach(({label, code})=>{
        const row = document.createElement('div'); row.className='kv';
        const k = document.createElement('code'); k.textContent = label ?? 'label';
        const v = document.createElement('code'); v.textContent = code ?? '';
        row.appendChild(k); row.appendChild(v);
        wrap.appendChild(row);
      });

      main.appendChild(d);
    });

    panelRight.appendChild(main);
  }

  function renderPair(container, gen){
    const pair = document.createElement('section'); pair.className='pair grid';

    // LEFT: generator panel
    const left = document.createElement('section'); left.className='panel';
    const lh = document.createElement('header');
    const h2 = document.createElement('h2'); 
    if(gen.id === 'campaign'){h2.textContent = 'Campaign Name Generator';}
    else if(gen.id === 'adgroup'){h2.textContent = 'Ad Group Name Generator';}
    else if(gen.id === 'asset'){h2.textContent = 'Asset Name Generator';}
    else {h2.textContent = 'Generator';} lh.appendChild(h2);
    const leftControls = document.createElement('div'); leftControls.style.display='flex'; leftControls.style.gap='8px'; leftControls.style.alignItems='center';
    const allReq = !(gen.optional && gen.optional.length);
    const reqChip = document.createElement('span');
    reqChip.className = 'badge';
    reqChip.textContent = allReq ? 'All fields required' : `${gen.optional.length} optional`;
    leftControls.appendChild(reqChip);
    const clearBtnHead = document.createElement('button'); clearBtnHead.textContent='Clear'; clearBtnHead.className='btn clear'; leftControls.appendChild(clearBtnHead);
    lh.appendChild(leftControls);
    lh.style.justifyContent='space-between';
    left.appendChild(lh);

    const lm = document.createElement('main');

    // controls
    const controls = document.createElement('div'); controls.className='controls'; lm.appendChild(controls);

    // state per generator
    const state = {};  // field -> code
    const required = new Set((gen.order||[]).filter(f=>!(gen.optional||[]).includes(f)));

    (gen.order||[]).forEach(field=>{
      const row = document.createElement('div'); row.className='row';

      const label = document.createElement('div'); label.className='label';
      const lab = document.createElement('label'); lab.textContent = field; lab.setAttribute('for', `${gen.id}_${field}`);
      const hint = document.createElement('small'); if(!required.has(field)){ hint.textContent = 'Optional'; }
      label.appendChild(lab); label.appendChild(hint);

      const selWrap = document.createElement('div'); selWrap.className='select';
      const sel = document.createElement('select'); sel.id = `${gen.id}_${field}`; sel.setAttribute('data-field', field);
      const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='‚Äî choose ‚Äî'; placeholder.disabled=true; placeholder.selected=true;
      sel.appendChild(placeholder);
      (gen.fields[field]||[]).forEach(o=>{
        const opt = document.createElement('option'); opt.value=o.code; opt.textContent=o.label ?? o.code; sel.appendChild(opt);
      });
      selWrap.appendChild(sel);

      row.appendChild(label); row.appendChild(selWrap);
      controls.appendChild(row);

      sel.addEventListener('change', e=>{
        state[field] = e.target.value;
        sel.classList.remove('missing');
        compose();
      });
    });

    // output
    const outWrap = document.createElement('div'); outWrap.className='out';
    const outPre = document.createElement('pre'); outPre.id = `${gen.id}_out`; outWrap.appendChild(outPre);

    const copybar = document.createElement('div'); copybar.className='copybar';
    const copyBtn = document.createElement('button'); copyBtn.textContent='Copy'; copyBtn.className='btn primary'; copybar.appendChild(copyBtn);
    const statusPill = document.createElement('span'); statusPill.className='pill warn'; statusPill.innerHTML='<b>Select all fields</b>'; copybar.appendChild(statusPill);

    outWrap.appendChild(copybar);
    lm.appendChild(outWrap);

    // recents
    const recentWrap = document.createElement('div'); recentWrap.className='recent';
    const h3 = document.createElement('h3'); h3.textContent='Recent outputs'; recentWrap.appendChild(h3);
    const recentList = document.createElement('div'); recentList.className='recent-list'; recentList.id = `${gen.id}_recent`; recentWrap.appendChild(recentList);
    lm.appendChild(recentWrap);

    left.appendChild(lm);

    // RIGHT: convention panel
    const right = document.createElement('section'); right.className='panel';
    const rh = document.createElement('header');
    const rht = document.createElement('h2'); rht.textContent='Naming Convention'; rh.appendChild(rht);
    const mode = document.createElement('span'); mode.className='badge'; mode.textContent = SCHEMA_MODE; rh.appendChild(mode);
    rh.style.justifyContent='space-between'; right.appendChild(rh);
    
    // NEW: create a content container inside the right panel
    const rightContent = document.createElement('main');
    right.appendChild(rightContent);

    // UPDATED: only render into the content container (leaves header + badge intact)
    renderConvention(rightContent, gen);

    // mount
    pair.appendChild(left);
    pair.appendChild(right);
    container.appendChild(pair);

    const RECENTS_KEY = `ng_recent_${gen.id}`;

    function renderRecents(){
      recentList.innerHTML='';
      try{
        const raw = localStorage.getItem(RECENTS_KEY);
        const arr = raw? JSON.parse(raw): [];
        arr.forEach(v=>{
          const pill=document.createElement('div'); pill.className='recent-pill';
          const code=document.createElement('code'); code.textContent=v; pill.appendChild(code);
          const btn=document.createElement('button'); btn.type='button'; btn.textContent='√ó'; btn.setAttribute('aria-label','remove');
          btn.addEventListener('click',()=>{
            const raw=localStorage.getItem(RECENTS_KEY);
            const arr=raw? JSON.parse(raw): [];
            const next=arr.filter(x=>x!==v);
            localStorage.setItem(RECENTS_KEY, JSON.stringify(next));
            renderRecents();
          });
          pill.appendChild(btn);
          recentList.appendChild(pill);
        });
      }catch(e){}
    }

    function addRecent(val){
      try{
        const raw=localStorage.getItem(RECENTS_KEY);
        const arr=raw? JSON.parse(raw): [];
        const filtered = arr.filter(x=>x!==val);
        filtered.unshift(val);
        const limited = filtered.slice(0, 12);
        localStorage.setItem(RECENTS_KEY, JSON.stringify(limited));
        renderRecents();
      }catch(e){}
    }

    function allSelected(){
      return (gen.order||[]).every(f => {
        if(!required.has(f)) return true; // optional allowed
        return !!state[f];
      });
    }

    function highlightMissing(){
      (gen.order||[]).forEach(f=>{
        if(required.has(f) && !state[f]){
          const el = document.getElementById(`${gen.id}_${f}`);
          el && el.classList.add('missing');
        }
      });
    }

    function resetAll(){
      (gen.order||[]).forEach(f=>{
        const el=document.getElementById(`${gen.id}_${f}`);
        if(el){ el.selectedIndex=0; el.classList.remove('missing'); }
        state[f]='';
      });
      compose();
    }

    function compose(){
      const delimiter = gen.delimiter || '_';
      const parts = (gen.order||[]).map(f => state[f] || '');
      const cased = parts.map(p => byCase(p, gen.case||'lower'));
      const joined = cased.filter(Boolean).join(delimiter);
      const ok = allSelected();
      statusPill.className = ok ? 'pill ok' : 'pill warn';
      statusPill.innerHTML = ok ? '<b>Ready to copy</b>' : '<b>Select all fields</b>';
      outPre.textContent = joined || 'Select values to generate‚Ä¶';
    }

    async function copyOut(){
      if(!allSelected()){
        highlightMissing();
        toast('Please select all required fields');
        return;
      }
      const delimiter = gen.delimiter || '_';
      const parts = (gen.order||[]).map(f => state[f] || '');
      const cased = parts.map(p => byCase(p, gen.case||'lower'));
      const out = cased.filter(Boolean).join(delimiter);
      try{
        await navigator.clipboard.writeText(out);
        toast('Copied to clipboard');
        addRecent(out);
        resetAll();
      }catch(e){
        const ta=document.createElement('textarea'); ta.value=out; document.body.appendChild(ta); ta.select();
        const ok=document.execCommand('copy'); document.body.removeChild(ta);
        if(ok){ toast('Copied'); addRecent(out); resetAll(); }
        else { toast('Copy failed'); }
      }
    }

    copyBtn.addEventListener('click', copyOut);
    clearBtnHead.addEventListener('click', resetAll);

    renderRecents();
    compose();
  }

  function renderAll(){
    const pairs = document.getElementById('pairs');
    pairs.innerHTML = '';
    
    if (!MASTER || !MASTER.generators) {
      pairs.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">Loading schema...</div>';
      return;
    }
    
    // Render ALL generators
    MASTER.generators.forEach(gen => renderPair(pairs, gen));
  }

  // Main initialization with fallback chain
  async function initialize() {
    // Show loading state
    renderAll();
    
    // 1. Try CSV first (primary source)
    const csvSuccess = await loadFromCSV();
    if (csvSuccess) return;
    
    // 2. Try remote JSON files (fallback)
    const remoteSuccess = await loadFromRemoteJSON('schema.master.json') || 
                          await loadFromRemoteJSON('schema.json');
    if (remoteSuccess) return;
    
    // 3. Try cached data (last resort)
    const cacheSuccess = loadFromCache();
    if (cacheSuccess) return;
    
    // 4. All sources failed
    SCHEMA_MODE = 'No Data Available';
    const pairs = document.getElementById('pairs');
    pairs.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--danger)">
        <h3>Unable to load schema</h3>
        <p style="color:var(--muted)">Could not load from CSV, remote JSON, or cache.</p>
        <button onclick="initialize()" class="btn primary" style="margin-top:12px">Retry</button>
      </div>
    `;
  }

  // Boot sequence
  initialize();
  </script>
</body>
</html>